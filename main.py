import streamlit as st
import streamlit.components.v1 as components
from autolit.file_importer import File
from autolit.data_reader import Information
from autolit.alt_plotter import ALT_Plots
from autolit.slide import SlideShow
from autolit.autopipe import Autolitpred
from autolit.sns_plotter import SNS_Plots

from sklearn.impute import SimpleImputer
from sklearn.preprocessing import StandardScaler, OneHotEncoder
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.ensemble import AdaBoostClassifier
from xgboost import XGBClassifier
from sklearn.utils import estimator_html_repr

import altair as alt
import matplotlib.pyplot as plt
import seaborn as sns
sns.set_theme()

import numpy as np

section = st.sidebar.selectbox('Section', ('Home', 'Upload Data', 'Explore Data', 'Modeling'))


if section == 'Home':
    st.title('Autolit')
    
    st.write('''
            Streamlining explanatory data analysis and machine-learning of tabular information, and wrapping it in a streamlit app.
            
            ---
            ### Work flow of app
            - Upload Data
            - Choose where to get your data.
            - Confirm file type and import
            - Explore Data
            - Observe interesting plots and basic data descriptions
            - Modeling
            - Construct pipeline to predict on data
            ---            
             ''')
    
    image = 'https://images.unsplash.com/photo-1543286386-713bdd548da4?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=750&q=80'
    st.image(image, 'Data is Interesting')
elif section == 'Upload Data':
    st.write('''
            How to upload:
            - Choose where to get your data. Either upload your own, use link, or default loan data
            - Confirm the data type (csv or xls)
            - Import the data''')
    with st.form('Data chooser'):
        import_choice = st.selectbox(label='Choose where to get your data.', options=('Loan_Data', 'Upload', 'Link'))
        if import_choice == 'Loan_Data':
            upload = 'data/data.csv'
        elif import_choice == 'Upload':
            upload = st.file_uploader(label='File Here')
        else:
            upload = st.text_input(label='enter link here')
        choose_submit = st.form_submit_button('Choose data')
        if choose_submit:
            st.session_state.DATA = upload   
    
    
    if 'DATA' not in st.session_state:
        st.title('Upload Data to Explore')
    else:
        file_type = st.selectbox(label='filetype', options=('csv', 'xls'))
        if file_type == 'csv':
            with st.form('Import csv'):
                st.subheader('Import csv file here')
                file = File(st.session_state.DATA)
                sep = st.selectbox('seperator', (',', ';', '    '), help='blank selection is for tab seperated sheets.')
                csv_submitted = st.form_submit_button('Import csv')
                if csv_submitted:
                    file = file.import_csv(sep)
                    st.session_state.df = file
                    file
                    
        elif file_type == 'xls':   
            with st.form('Import xls'):
                st.subheader('Import xls file here')
                file = File(st.session_state.DATA)
                sheetnames = file.xls_sheets()
                sheetname = st.selectbox('sheetname', (sheetnames), help='Choose which excel sheet to use data from.')
                xls_submitted = st.form_submit_button('Import xls')
                if xls_submitted:
                    file = file.import_xls(sheetname)
                    st.session_state.df = file
                    file
                    

elif section == 'Explore Data':
    if 'df' not in st.session_state:
        st.title('Upload Data to Explore')
    else:
        st.title('Autogenerated plots')
        st.write('''
                - Distribution plots are displayed in descending order, with respect to their skew.
                - Correlation plots are displayed in descending order, with respect to their correlation.
                
                ---''')
        df = st.session_state.df
        if len(df) > 5000:
            df = st.session_state.df.sample(5000, random_state=0)
        info = Information(df)
        st.header('Data Types')
        st.dataframe(info.information()['Data Type'].reset_index().rename(columns={'index':'variable'}).transpose())
        
        skew_list = info.skew_list()
        corr_list, _ = info.corr_list()

        plotter = ALT_Plots(df)
        skew_plots = plotter.skew_plotter(skew_list)
        corr_plots = plotter.corr_plotter(corr_list)
        info_plots = plotter.info_plotter(info.information())

        html = open('src/slide.html', 'r').read()
        css = open('src/style.css', 'r').read()
        js = open('src/script.js', 'r').read()

        skew_sl = SlideShow(skew_plots, html, css, js)
        skew_sl = skew_sl.create()
        corr_sl = SlideShow(corr_plots, html, css, js)
        corr_sl = corr_sl.create()
        info_sl = SlideShow(info_plots, html, css, js)
        info_sl = info_sl.create()
        
        st.header('Distribution Plots')
        components.html(skew_sl, height=400,scrolling=True)
        st.write('---')
        st.header('Correlation Plots')
        components.html(corr_sl, height=400,scrolling=True)
        st.write('---') 
        st.header('General Information')
        st.markdown('''
                    This is information about
                    - Percent of missing values
                    - Number of values''')
        components.html(info_sl, height=500,scrolling=True) 
        st.write('---')


        snsplots = SNS_Plots(df)


        st.header('Correlation Matrix')
        st.markdown('''Standard pearson correlation between numerical variables''')
        heatmap = snsplots.heatmap()
        st.pyplot(heatmap)
        # f = open('test.html', 'w')
        # f.write(corr_sl)
        # f.close()      
        st.write('---')  
        st.markdown('''
                    These forms allow for more plot viewing. 
                    - Displays plots in groups of 9 or less
                    - Useless columns such as ID** may make countplot loading long''')
        st.header('Optional Boxplot examiner')
        snsplots.boxplots()
        st.header('Optional Countplot examiner')
        snsplots.countplots()
elif section == 'Modeling':
    if 'df' not in st.session_state:
        st.title('Upload Data to Explore')
        
    else:
        st.title('Modeling the Data')
        

        data = st.session_state.df

        st.markdown('---')
        with st.form('Contruct Pipeline'):
            st.header('Contruct Pipeline')

            st.subheader('Predictors')
            numeric_features = st.multiselect('Numeric Features', data.select_dtypes('number').columns.tolist())
            numeric_transformer = [SimpleImputer(), StandardScaler()]
            st.markdown('---')

            categorical_features = st.multiselect('Categorical Features', data.select_dtypes('object').columns.tolist())
            categorical_transformer = [SimpleImputer(strategy='most_frequent'), OneHotEncoder()]

            st.markdown('---')
            st.subheader('Target')

            target = st.selectbox('Target', data.columns)

            st.markdown('---')
            st.subheader('Algorithm')
            
            algo = st.selectbox('algorithm', (LogisticRegression(), RandomForestClassifier(), AdaBoostClassifier(), XGBClassifier()))

            if st.form_submit_button('Start Pipeline'):

                st.markdown('---')

                al = Autolitpred(numeric_features,
                                        categorical_features,
                                        numeric_transformer,
                                        categorical_transformer,
                                        algo)
                
                pred = al.pipline()
                
                
                st.header('Pipeline Schema')
                components.html(estimator_html_repr(pred), scrolling=True)
                # with open('my_estimator.html', 'w') as f:  
                #     f.write(estimator_html_repr(pred))
                #     f.close()
                
                st.header('Pipeline Evaluation')
                X_train, X_test, y_train, y_test = train_test_split(data[numeric_features + categorical_features], data[target], test_size=0.2,
                                                                    random_state=0)

                pred.fit(X_train, y_train)
                st.write(f'Accuracy {pred.score(X_test, y_test)}')